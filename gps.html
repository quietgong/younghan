<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>실시간 위치 정보</title>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBr4PpRcc8az-paeV336EDFLpFgkB2FQxQ"></script>
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
</head>

<body>
  <h1>실시간 위치 추적</h1>
  <div id="map">지도 로드 중...</div>
  <p id="location">위치 정보가 여기에 표시됩니다.</p>

  <script>
    let userName;
    let lastLatitude = null;
    let lastLongitude = null;
    let lastHeading = null;
    let map, marker;
    let intervalID;

    const trackingInterval = 3000;

    function getUserName() {
      userName = prompt("닉네임을 입력하세요");
    }

    function initMap(latitude, longitude) {
      const userPosition = { lat: latitude, lng: longitude };

      // 지도 초기화
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: userPosition,
      });

      // 사용자 지정 이미지를 마커로 표시
      const icon = {
        url: "arrow.png", // 원하는 이미지 URL
        scaledSize: new google.maps.Size(50, 50), // 이미지 크기 설정
      };

      marker = new google.maps.Marker({
        position: userPosition,
        map: map,
        icon: icon, // 이미지 사용
        title: "현재 위치"
      });
    }

    function startTracking() {
      intervalID = setInterval(() => {
        navigator.geolocation.getCurrentPosition(showPosition, showError, {
          enableHighAccuracy: true
        });
      }, trackingInterval); // 5초 주기
    }

    function stopTracking() {
      if (intervalID) {
        clearInterval(intervalID);
        document.getElementById("location").innerHTML = "위치 추적이 중지되었습니다.";
      }
    }

    async function showPosition(position) {
      const currentLatitude = position.coords.latitude;
      const currentLongitude = position.coords.longitude;
      const heading = position.coords.heading; // 기기의 방향 (도 단위)
      console.log(`device heading = ${heading}`);

      // 위치가 변화한 경우에만 위치 업데이트
      if (currentLatitude !== lastLatitude || currentLongitude !== lastLongitude) {
        lastLatitude = currentLatitude;
        lastLongitude = currentLongitude;

        const newPosition = { lat: currentLatitude, lng: currentLongitude };
        marker.setPosition(newPosition);
        map.setCenter(newPosition);

        const data = {
          "userName": userName,
          "latitude": currentLatitude,
          "longitude": currentLongitude
        };

        // GPS 정보 서버로 전송
        // try {
        //   const res = await axios.post("http://115.20.193.140:8888/gps", data);
        //   console.log(res.data);
        // } catch (error) {
        //   console.error(error);
        // }
      }
      document.getElementById("location").innerHTML = "실시간 위도: " + currentLatitude + "<br>실시간 경도: " + currentLongitude + "<br>실시간 헤딩: " + heading;
      showHeading(heading);
      
    }

    function showHeading(heading){
      console.log(`heading = ${heading}`);
      // heading 값이 변할 때 마커 회전
      if (heading !== null && heading !== lastHeading) {
        lastHeading = heading;

        marker.setIcon({
          url: "arrow.png", // 마커 이미지
          scaledSize: new google.maps.Size(50, 50), // 이미지 크기
          rotation: heading // 방향에 따라 회전
        });
      }
    }

    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("location").innerHTML = "위치 정보 제공을 거부했습니다.";
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("location").innerHTML = "위치 정보를 사용할 수 없습니다.";
          break;
        case error.TIMEOUT:
          document.getElementById("location").innerHTML = "위치 정보 요청 시간이 초과되었습니다.";
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("location").innerHTML = "알 수 없는 오류가 발생했습니다.";
          break;
      }
    }

    // getUserName();
    navigator.geolocation.getCurrentPosition(function (position) {
      initMap(position.coords.latitude, position.coords.longitude);
      startTracking();
    }, showError);
  </script>
</body>

</html>
