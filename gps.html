<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>실시간 위치 정보</title>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <!-- Google Maps API, callback 추가 -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBr4PpRcc8az-paeV336EDFLpFgkB2FQxQ&callback=initMap"></script>
  <link rel="stylesheet" href="gps.css">
</head>

<body>
  <div id="map">지도 로드 중...</div>
  <button class="center-button" onclick="location.href='https://plinqer.8thwall.app/proximity'">GO TO AR MODE</button>
  <button id="alphaBtn" class="heading-button"></button>

  <script>
    let userName;
    let lastLatitude = null;
    let lastLongitude = null;
    let lastAlpha = null;
    let map, marker, currentOverlay;
    const trackingInterval = 1000;

    function getUserName() {
      userName = prompt("닉네임을 입력하세요");
    }

    function initMap() {
      // 위치 정보 먼저 가져오기
      navigator.geolocation.getCurrentPosition(function (position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const userPosition = { lat: latitude, lng: longitude };

        // 지도 초기화
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 16,
          center: userPosition,
        });

        // 커스텀 마커를 위한 HTML 요소 생성
        markerElement = document.createElement('div');
        markerElement.className = 'custom-marker';

        // 커스텀 오버레이 정의
        class CustomMarker extends google.maps.OverlayView {
          constructor(position) {
            super();
            this.position = position;
          }

          onAdd() {
            const panes = this.getPanes();
            panes.overlayLayer.appendChild(markerElement);
          }

          draw() {
            const projection = this.getProjection();
            const position = projection.fromLatLngToDivPixel(this.position);

            if (position) {
              markerElement.style.left = position.x + 'px';
              markerElement.style.top = position.y + 'px';
            }
          }

          onRemove() {
            markerElement.parentNode.removeChild(markerElement);
          }

          setPosition(position) {
            this.position = position;
            this.draw();
          }
        }

        // 커스텀 마커 오버레이 추가
        currentOverlay = new CustomMarker(userPosition);
        currentOverlay.setMap(map);

        // 트래킹 시작
        startTracking();
      }, showError);
    }

    // 마커 회전 함수 (CSS transform 사용)
    function rotateMarker(alpha) {
      const alphaBtn = document.getElementById("alphaBtn");
      alphaBtn.innerText = alpha;
      markerElement.style.transform = `rotate(${-alpha}deg)`;
    }

    // 위치와 헤딩을 업데이트하는 함수
    function updatePosition(latitude, longitude, heading) {
      const newPosition = new google.maps.LatLng(latitude, longitude);
      currentOverlay.setPosition(newPosition);
    }

    function startTracking() {
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(currentPos, showError)
      }, trackingInterval);
    }

    async function getAlpha() {
      return new Promise((resolve) => {
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', (event) => {
            let alpha = event.alpha;
            if (lastAlpha !== null) {
              if (Math.abs(alpha - lastAlpha) > 180) {
                if (alpha > lastAlpha) {
                  alpha -= 360;
                } else {
                  alpha += 360;
                }
              }
            }
            lastAlpha = alpha;
            resolve(parseInt(alpha));
          }, { once: true });
        } else {
          resolve(null);
        }
      });
    }

    async function currentPos(pos) {
      const currentLatitude = pos.coords.latitude;
      const currentLongitude = pos.coords.longitude;
      const currentAlpha = await getAlpha();

      rotateMarker(currentAlpha);
      updatePosition(currentLatitude, currentLongitude);
    }

    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("location").innerHTML = "위치 정보 제공을 거부했습니다.";
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("location").innerHTML = "위치 정보를 사용할 수 없습니다.";
          break;
        case error.TIMEOUT:
          document.getElementById("location").innerHTML = "위치 정보 요청 시간이 초과되었습니다.";
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("location").innerHTML = "알 수 없는 오류가 발생했습니다.";
          break;
      }
    }
  </script>
</body>

</html>