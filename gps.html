<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>실시간 위치 정보</title>
  <link rel="stylesheet" href="gps.css">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <!-- Google Maps API, callback 추가 -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBr4PpRcc8az-paeV336EDFLpFgkB2FQxQ&callback=initMap"></script>
</head>

<body>
  <div id="map">지도 로드 중...</div>
  <button class="center-button" onclick="location.href='https://plinqer.8thwall.app/proximity'">GO TO AR MODE</button>

  <script>
    let userName;
    let lastLatitude = null;
    let lastLongitude = null;
    let lastAlpha = null;
    let map, marker, currentOverlay;
    const trackingInterval = 1000;

    function showError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          document.getElementById("location").innerHTML = "위치 정보 제공을 거부했습니다.";
          break;
        case error.POSITION_UNAVAILABLE:
          document.getElementById("location").innerHTML = "위치 정보를 사용할 수 없습니다.";
          break;
        case error.TIMEOUT:
          document.getElementById("location").innerHTML = "위치 정보 요청 시간이 초과되었습니다.";
          break;
        case error.UNKNOWN_ERROR:
          document.getElementById("location").innerHTML = "알 수 없는 오류가 발생했습니다.";
          break;
      }
    }

    function rotateMarker(alpha) {
      markerElement.style.transform = `rotate(${-alpha}deg)`;
      lastAlpha = alpha;
    }

    window.addEventListener('deviceorientation', function (event) {
      let currentAlpha = event.alpha;
      if (lastAlpha !== null && lastAlpha !== currentAlpha) {
        if (Math.abs(currentAlpha - lastAlpha) > 180) {
          if (currentAlpha > lastAlpha) {
            currentAlpha -= 360;
          } else {
            currentAlpha += 360;
          }
        }
      }
      rotateMarker(currentAlpha);
    });

    // initMap을 전역 함수로 정의
    window.initMap = function () {
      navigator.geolocation.getCurrentPosition(function (position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const userPosition = { lat: latitude, lng: longitude };

        // 지도 초기화
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 16,
          center: userPosition,
        });

        // 커스텀 마커를 위한 HTML 요소 생성
        markerElement = document.createElement('div');
        markerElement.className = 'custom-marker';

        // 커스텀 오버레이 정의
        class CustomMarker extends google.maps.OverlayView {
          constructor(position) {
            super();
            this.position = position;
          }

          onAdd() {
            const panes = this.getPanes();
            panes.overlayLayer.appendChild(markerElement);
          }

          draw() {
            const projection = this.getProjection();
            const position = projection.fromLatLngToDivPixel(this.position);

            if (position) {
              markerElement.style.left = position.x + 'px';
              markerElement.style.top = position.y + 'px';
            }
          }

          onRemove() {
            markerElement.parentNode.removeChild(markerElement);
          }

          setPosition(position) {
            this.position = position;
            this.draw();
          }
        }

        // 커스텀 마커 오버레이 추가
        currentOverlay = new CustomMarker(userPosition);
        currentOverlay.setMap(map);

        // 트래킹 시작
        startTracking();
      }, showError);
    };

    function startTracking() {
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(currentPos, showError)
      }, trackingInterval);
    }

    async function savePosition(data) {
      try {
        const res = await axios.post("http://115.20.193.140:8888/gps", data);
        console.log(res.data);
      } catch (error) {
        console.error(error);
      }
    }

    async function updatePosition(lat, lng) {
      if (lat !== lastLatitude || lng !== lastLongitude) {
        lastLatitude = lat;
        lastLongitude = lng;

        const newPosition = { lat: lat, lng: lng };
        currentOverlay.setPosition(newPosition);
        map.setCenter(newPosition);

        const data = {
          "userName": userName,
          "latitude": lat,
          "longitude": lng
        };

        await savePosition(data); // GPS 정보 서버로 전송
      }
    }

    async function currentPos(pos) {
      const currentLatitude = pos.coords.latitude;
      const currentLongitude = pos.coords.longitude;
      const newPosition = new google.maps.LatLng(currentLatitude, currentLongitude);
      currentOverlay.setPosition(newPosition);
      await updatePosition(currentLatitude, currentLongitude);
    }
  </script>
</body>

</html>